<div class="container mx-auto px-4 py-6" cdkDropListGroup>
  <!-- Back button -->
  <div class="mb-4">
    <button mat-stroked-button (click)="goBack()" class="text-gray-600">
      <mat-icon class="mr-1">arrow_back</mat-icon>
      è¿”å›è¨­å®š
    </button>
  </div>

  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-800">
      <mat-icon class="mr-2 text-3xl align-middle">groups</mat-icon>
      åˆ†çµ„ç®¡ç†
    </h1>

    <!-- Settings button -->
    <button
      mat-fab
      color="primary"
      (click)="openConditionsDialog()"
      class="!w-12 !h-12"
      matTooltip="åˆ†çµ„æ¢ä»¶è¨­å®š"
    >
      <mat-icon>settings</mat-icon>
    </button>
  </div>

  <!-- Students Pool -->
  <mat-card class="mb-6">
    <mat-card-header>
      <mat-card-title class="flex items-center">
        <mat-icon class="mr-2">person</mat-icon>
        å­¸ç”Ÿåˆ—è¡¨ ({{ availableStudents().length }} äºº)
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <!-- Add students input -->
      <div class="flex gap-4 mb-4">
        <mat-form-field class="flex-1">
          <mat-label>æ–°å¢ç”·ç”Ÿ</mat-label>
          <input
            matInput
            [(ngModel)]="newMaleInput"
            placeholder="1,2,3 æˆ– 1-5"
          />
        </mat-form-field>
        <button
          mat-button
          (click)="addMaleStudents()"
          [disabled]="!newMaleInput()"
        >
          <mat-icon>add</mat-icon>
          æ–°å¢
        </button>

        <mat-form-field class="flex-1">
          <mat-label>æ–°å¢å¥³ç”Ÿ</mat-label>
          <input
            matInput
            [(ngModel)]="newFemaleInput"
            placeholder="1,2,3 æˆ– 1-5"
          />
        </mat-form-field>
        <button
          mat-button
          (click)="addFemaleStudents()"
          [disabled]="!newFemaleInput()"
        >
          <mat-icon>add</mat-icon>
          æ–°å¢
        </button>
      </div>

      <!-- Absent students -->
      <div class="mb-4">
        <mat-form-field class="w-full">
          <mat-label>ç¼ºå¸­å­¸ç”Ÿåº§è™Ÿ</mat-label>
          <input matInput [(ngModel)]="absentInput" placeholder="3,5,7" />
          <mat-hint>è¼¸å…¥ç¼ºå¸­å­¸ç”Ÿçš„åº§è™Ÿï¼Œé€™äº›å­¸ç”Ÿå°‡è¢«ç§»é™¤</mat-hint>
        </mat-form-field>
        <button mat-button (click)="setAbsentStudents()" class="ml-2">
          <mat-icon>person_remove</mat-icon>
          è¨­å®šç¼ºå¸­
        </button>
      </div>

      <!-- Students display -->
      <div
        cdkDropList
        [cdkDropListData]="availableStudents()"
        id="available"
        (cdkDropListDropped)="onDrop($event)"
        class="flex flex-wrap gap-2 min-h-[100px] p-4 border-2 border-dashed border-gray-300 rounded-lg"
        [class.drag-over]="isDragOver()"
      >
        <div
          *ngFor="let student of availableStudents(); trackBy: trackByStudentId"
          cdkDrag
          class="student-card flex items-center px-3 py-2 rounded-lg cursor-move relative group"
          [class]="getStudentGenderClass(student)"
        >
          <span class="font-medium">
            {{ student.gender === "male" ? "ç”·" : "å¥³" }}{{ student.id }}
          </span>
          <button
            (click)="removeStudent(student.id)"
            class="ml-2 opacity-0 group-hover:opacity-100 transition-opacity"
            mat-icon-button
            [attr.aria-label]="'ç§»é™¤å­¸ç”Ÿ ' + student.id"
          >
            <mat-icon class="text-sm">close</mat-icon>
          </button>
        </div>

        <div
          *ngIf="availableStudents().length === 0"
          class="text-gray-500 text-center w-full py-8"
        >
          æ‰€æœ‰å­¸ç”Ÿå·²åˆ†çµ„æˆ–ç„¡å­¸ç”Ÿè³‡æ–™
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Groups -->
  <div class="space-y-6 mb-6">
    <div class="flex justify-between items-start">
      <div>
        <h2 class="text-xl font-bold text-gray-800">åˆ†çµ„çµæœ</h2>
        <p class="text-sm text-gray-600 mt-1">
          ğŸ’¡ æç¤ºï¼šé»æ“Šå­¸ç”Ÿå¯ä»¥è¨­ç‚ºçµ„é•·ï¼Œæ‹–æ›³å­¸ç”Ÿå¯ä»¥æ›çµ„
        </p>
      </div>
      <!-- æ¬¡è¦åŠŸèƒ½æŒ‰éˆ•ç§»åˆ°å³ä¸Šè§’ -->
      <div class="flex gap-2">
        <button
          mat-stroked-button
          color="accent"
          (click)="selectRandomLeaders()"
          [disabled]="hasNoStudentsInGroups()"
          class="!py-2"
        >
          <mat-icon class="mr-1">star</mat-icon>
          éš¨æ©Ÿé¸çµ„é•·
        </button>

        <button
          mat-stroked-button
          (click)="copyResults()"
          [disabled]="hasNoStudentsInGroups()"
          class="!py-2"
        >
          <mat-icon class="mr-1">content_copy</mat-icon>
          è¤‡è£½çµæœ
        </button>
      </div>
    </div>

    <!-- ä¸»è¦åŠŸèƒ½æŒ‰éˆ• - å±…ä¸­é¡¯ç¤º -->
    <div class="flex justify-center mb-6">
      <button
        mat-raised-button
        color="primary"
        (click)="performGrouping()"
        [disabled]="isLoading() || availableStudents().length === 0"
        class="!text-xl !font-bold !px-12 !py-4 !min-h-[64px] shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 !rounded-full"
      >
        <mat-spinner
          *ngIf="isLoading()"
          diameter="28"
          class="mr-4"
        ></mat-spinner>
        <mat-icon *ngIf="!isLoading()" class="mr-4 !text-3xl">shuffle</mat-icon>
        {{ isLoading() ? "åˆ†çµ„ä¸­..." : "ğŸ² é–‹å§‹è‡ªå‹•åˆ†çµ„" }}
      </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <mat-card
        *ngFor="let group of groups(); trackBy: trackByGroupId"
        class="group-container"
        [class.has-students]="group.students.length > 0"
      >
        <mat-card-header>
          <mat-card-title class="text-lg">{{ group.name }}</mat-card-title>
          <mat-card-subtitle
            >{{ group.students.length }} äºº{{
              getGenderDistribution(group)
            }}</mat-card-subtitle
          >
        </mat-card-header>
        <mat-card-content>
          <div
            cdkDropList
            [cdkDropListData]="group.students"
            [id]="group.id"
            (cdkDropListDropped)="onDrop($event)"
            class="min-h-[120px] space-y-2"
          >
            <div
              *ngFor="let student of group.students; trackBy: trackByStudentId"
              cdkDrag
              class="student-card flex items-center justify-between px-3 py-2 rounded cursor-pointer hover:bg-opacity-80 transition-all duration-200"
              [class]="getStudentCardClass(student)"
              (click)="toggleLeader(group.id, student.id)"
              [matTooltip]="student.isLeader ? 'é»æ“Šå–æ¶ˆçµ„é•·' : 'é»æ“Šè¨­ç‚ºçµ„é•·'"
              matTooltipPosition="above"
            >
              <span class="flex items-center">
                <mat-icon
                  *ngIf="student.isLeader"
                  class="leader-star mr-1 text-lg animate-pulse"
                  >star</mat-icon
                >
                <mat-icon
                  *ngIf="!student.isLeader"
                  class="potential-leader mr-1 text-lg opacity-30 group-hover:opacity-70 transition-opacity"
                  >star_border</mat-icon
                >
                {{ student.gender === "male" ? "ç”·" : "å¥³" }}{{ student.id }}
              </span>
              <span
                *ngIf="student.isLeader"
                class="text-xs bg-yellow-200 text-yellow-800 px-2 py-1 rounded"
                >çµ„é•·</span
              >
            </div>

            <div
              *ngIf="group.students.length === 0"
              class="text-gray-400 text-center py-8 text-sm"
            >
              æ‹–æ‹‰å­¸ç”Ÿåˆ°æ­¤è™•
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
