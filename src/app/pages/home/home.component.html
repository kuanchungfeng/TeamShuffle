<div class="container mx-auto px-4 py-6" cdkDropListGroup>
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-800">
      <mat-icon class="mr-2 text-3xl align-middle">groups</mat-icon>
      åˆ†çµ„ç®¡ç†
    </h1>

    <!-- Settings button -->
    <button
      mat-fab
      color="primary"
      (click)="openConditionsDialog()"
      class="!w-12 !h-12"
      matTooltip="åˆ†çµ„æ¢ä»¶è¨­å®š"
    >
      <mat-icon>settings</mat-icon>
    </button>
  </div>

  <!-- Students Pool -->
  <mat-card class="mb-6">
    <mat-card-header>
      <mat-card-title class="flex items-center">
        <mat-icon class="mr-2">person</mat-icon>
        å­¸ç”Ÿåˆ—è¡¨ ({{ availableStudents().length }} äºº)
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <!-- Initial setup section -->
      <div
        class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 p-4 bg-gray-50 rounded-lg"
      >
        <div>
          <h3 class="text-lg font-medium mb-3 text-gray-700">åˆå§‹è¨­å®š</h3>
          <div class="space-y-3">
            <mat-form-field class="w-full">
              <mat-label>å¥³ç”Ÿåº§è™Ÿ</mat-label>
              <input
                matInput
                [(ngModel)]="femaleInput"
                (input)="onFemaleInputChange()"
                placeholder="ä¾‹å¦‚: 1-3,6-8"
                [class.mat-mdc-input-invalid]="femaleInputErrors().length > 0"
              />
              <mat-hint *ngIf="femaleInputErrors().length === 0">
                ä½¿ç”¨é€—è™Ÿåˆ†éš”ï¼Œæ”¯æ´ç¯„åœè¡¨ç¤ºæ³•
              </mat-hint>
            </mat-form-field>
            <div
              *ngIf="femaleInputErrors().length > 0"
              class="text-red-600 text-sm -mt-2 mb-2 flex items-center"
            >
              <mat-icon class="mr-1 text-sm">error</mat-icon>
              {{ femaleInputErrors().join(", ") }}
            </div>

            <mat-form-field class="w-full">
              <mat-label>ç”·ç”Ÿåº§è™Ÿ</mat-label>
              <input
                matInput
                [(ngModel)]="maleInput"
                (input)="onMaleInputChange()"
                placeholder="ä¾‹å¦‚: 1-5,7-9"
                [class.mat-mdc-input-invalid]="maleInputErrors().length > 0"
              />
              <mat-hint *ngIf="maleInputErrors().length === 0">
                ä½¿ç”¨é€—è™Ÿåˆ†éš”ï¼Œæ”¯æ´ç¯„åœè¡¨ç¤ºæ³•
              </mat-hint>
            </mat-form-field>
            <div
              *ngIf="maleInputErrors().length > 0"
              class="text-red-600 text-sm -mt-2 mb-2 flex items-center"
            >
              <mat-icon class="mr-1 text-sm">error</mat-icon>
              {{ maleInputErrors().join(", ") }}
            </div>
          </div>
        </div>

        <div>
          <h3 class="text-lg font-medium mb-3 text-gray-700">åˆ†çµ„è¨­å®š</h3>
          <div class="space-y-3">
            <mat-form-field class="w-full">
              <mat-label>åˆ†çµ„æ•¸é‡</mat-label>
              <input
                matInput
                type="number"
                [(ngModel)]="groupCount"
                min="2"
                max="20"
                (ngModelChange)="updateGroupCount()"
              />
              <mat-hint>è«‹è¼¸å…¥ 2-20 ä¹‹é–“çš„æ•¸å­—</mat-hint>
            </mat-form-field>

            <button
              mat-raised-button
              color="primary"
              (click)="initializeFromInputs()"
              [disabled]="!canInitialize()"
              class="w-full"
            >
              <mat-icon class="mr-2">add_box</mat-icon>
              æ–°å¢è‡³ä¸‹æ–¹å€å¡Š
            </button>
          </div>
        </div>
      </div>
      <!-- Absent students -->
      <div class="mb-4 flex gap-2 items-start">
        <mat-form-field class="flex-1">
          <mat-label>ç¼ºå¸­å­¸ç”Ÿåº§è™Ÿ</mat-label>
          <input matInput [(ngModel)]="absentInput" placeholder="3,5,7" />
          <mat-hint>è¼¸å…¥ç¼ºå¸­å­¸ç”Ÿçš„åº§è™Ÿï¼Œé€™äº›å­¸ç”Ÿå°‡è¢«ç§»é™¤</mat-hint>
        </mat-form-field>
        <button
          mat-raised-button
          color="warn"
          (click)="setAbsentStudents()"
          class="mt-0"
          [disabled]="!absentInput().trim()"
        >
          <mat-icon class="mr-2">person_remove</mat-icon>
          è¨­å®šç¼ºå¸­å­¸ç”Ÿ
        </button>
      </div>

      <!-- Students display -->
      <div
        cdkDropList
        [cdkDropListData]="availableStudents()"
        id="available"
        (cdkDropListDropped)="onDrop($event)"
        class="flex flex-wrap gap-2 min-h-[100px] p-4 border-2 border-dashed border-gray-300 rounded-lg"
        [class.drag-over]="isDragOver()"
      >
        <div
          *ngFor="let student of availableStudents(); trackBy: trackByStudentId"
          cdkDrag
          class="student-card flex items-center px-3 py-2 rounded-lg cursor-move relative group"
          [class]="getStudentGenderClass(student)"
        >
          <span class="font-medium">
            {{ student.gender === "male" ? "ç”·" : "å¥³" }}{{ student.id }}
          </span>
          <button
            (click)="removeStudent(student.id)"
            class="ml-2 opacity-0 group-hover:opacity-100 transition-opacity"
            mat-icon-button
            [attr.aria-label]="'ç§»é™¤å­¸ç”Ÿ ' + student.id"
          >
            <mat-icon class="text-sm">close</mat-icon>
          </button>
        </div>

        <div
          *ngIf="availableStudents().length === 0"
          class="text-gray-500 text-center w-full py-8"
        >
          æ‰€æœ‰å­¸ç”Ÿå·²åˆ†çµ„æˆ–ç„¡å­¸ç”Ÿè³‡æ–™
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Groups -->
  <div class="space-y-6 mb-6">
    <div class="flex justify-between items-start">
      <div>
        <h2 class="text-xl font-bold text-gray-800">åˆ†çµ„çµæœ</h2>
        <p class="text-sm text-gray-600 mt-1">
          ğŸ’¡ æç¤ºï¼šé»æ“Šå­¸ç”Ÿå¯ä»¥è¨­ç‚ºçµ„é•·ï¼Œæ‹–æ›³å­¸ç”Ÿå¯ä»¥æ›çµ„
        </p>
      </div>
      <!-- æ¬¡è¦åŠŸèƒ½æŒ‰éˆ•ç§»åˆ°å³ä¸Šè§’ -->
      <div class="flex gap-2">
        <button
          mat-stroked-button
          color="accent"
          (click)="selectRandomLeaders()"
          [disabled]="hasNoStudentsInGroups()"
          class="!py-2"
        >
          <mat-icon class="mr-1">star</mat-icon>
          éš¨æ©Ÿé¸çµ„é•·
        </button>

        <button
          mat-stroked-button
          (click)="copyResults()"
          [disabled]="hasNoStudentsInGroups()"
          class="!py-2"
        >
          <mat-icon class="mr-1">content_copy</mat-icon>
          è¤‡è£½çµæœ
        </button>
      </div>
    </div>

    <!-- ä¸»è¦åŠŸèƒ½æŒ‰éˆ• - å±…ä¸­é¡¯ç¤º -->
    <div class="flex justify-center mb-6 gap-4">
      <!-- åˆå§‹åˆ†çµ„æŒ‰éˆ• -->
      <button
        *ngIf="!hasGrouped()"
        mat-raised-button
        color="primary"
        (click)="performGrouping()"
        [disabled]="isLoading() || availableStudents().length === 0"
        class="!text-xl !font-bold !px-12 !py-4 !min-h-[64px] shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 !rounded-full"
      >
        <mat-spinner
          *ngIf="isLoading()"
          diameter="28"
          class="mr-4"
        ></mat-spinner>
        <mat-icon *ngIf="!isLoading()" class="mr-4 !text-3xl">shuffle</mat-icon>
        {{ isLoading() ? "åˆ†çµ„ä¸­..." : "ğŸ² é–‹å§‹è‡ªå‹•åˆ†çµ„" }}
      </button>

      <!-- é‡æ–°åˆ†çµ„æŒ‰éˆ• -->
      <button
        *ngIf="hasGrouped()"
        mat-raised-button
        color="accent"
        (click)="regroupStudents()"
        class="!text-xl !font-bold !px-12 !py-4 !min-h-[64px] shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 !rounded-full"
      >
        <mat-spinner
          *ngIf="isLoading()"
          diameter="28"
          class="mr-4"
        ></mat-spinner>
        {{ isLoading() ? "é‡æ–°åˆ†çµ„ä¸­..." : "ğŸ”„ é‡æ–°åˆ†çµ„" }}
      </button>
    </div>

    <div class="group-results">
      <mat-card
        *ngFor="let group of groups(); trackBy: trackByGroupId"
        class="group-container group-results__card"
        [class.has-students]="group.students.length > 0"
      >
        <mat-card-header class="group-results__header">
          <mat-card-title class="group-results__title">{{ group.name }}</mat-card-title>
          <mat-card-subtitle class="group-results__subtitle"
            >{{ group.students.length }} äºº{{
              getGenderDistribution(group)
            }}</mat-card-subtitle
          >
        </mat-card-header>
        <mat-card-content class="group-results__content">
          <div
            cdkDropList
            [cdkDropListData]="group.students"
            [id]="group.id"
            (cdkDropListDropped)="onDrop($event)"
            class="group-results__list"
          >
            <div
              *ngFor="let student of group.students; trackBy: trackByStudentId"
              cdkDrag
              class="student-card group-results__student"
              [class]="getStudentCardClass(student)"
              (click)="toggleLeader(group.id, student.id)"
              [matTooltip]="student.isLeader ? 'é»æ“Šå–æ¶ˆçµ„é•·' : 'é»æ“Šè¨­ç‚ºçµ„é•·'"
              matTooltipPosition="above"
            >
              <span class="flex items-center">
                <mat-icon
                  *ngIf="student.isLeader"
                  class="leader-star mr-2 text-2xl animate-pulse"
                  >star</mat-icon
                >
                <mat-icon
                  *ngIf="!student.isLeader"
                  class="potential-leader mr-2 text-2xl opacity-30 group-hover:opacity-70 transition-opacity"
                  >star_border</mat-icon
                >
                {{ student.gender === "male" ? "ç”·" : "å¥³" }}{{ student.id }}
              </span>
              <span
                *ngIf="student.isLeader"
                class="text-base bg-yellow-200 text-yellow-800 px-3 py-1 rounded"
                >çµ„é•·</span
              >
            </div>

            <div
              *ngIf="group.students.length === 0"
              class="text-gray-400 text-center py-8 text-lg"
            >
              æ‹–æ‹‰å­¸ç”Ÿåˆ°æ­¤è™•
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
